<!-- File: backend/services/auth-service/docs/architecture.md -->
# Архитектура Auth Service

## Содержание

- [Обзор архитектуры](#обзор-архитектуры)
- [Принципы проектирования](#принципы-проектирования)
- [Компоненты системы](#компоненты-системы)
  - [API Layer](#api-layer)
  - [Service Layer](#service-layer)
  - [Domain Layer](#domain-layer)
  - [Infrastructure Layer](#infrastructure-layer)
- [Потоки данных](#потоки-данных)
- [Интеграции](#интеграции)
- [Безопасность](#безопасность)
- [Масштабирование](#масштабирование)
- [Отказоустойчивость](#отказоустойчивость)
- [Мониторинг и логирование](#мониторинг-и-логирование)
- [Эволюция архитектуры](#эволюция-архитектуры)

## Обзор архитектуры

Auth Service построен на принципах чистой архитектуры (Clean Architecture) и гексагональной архитектуры (Hexagonal Architecture), что обеспечивает четкое разделение ответственности, независимость от фреймворков и баз данных, а также высокую тестируемость.

![Архитектура Auth Service](../docs/images/architecture.png)

Сервис реализует следующие основные функции:
- Аутентификация и авторизация пользователей
- Управление сессиями и токенами
- Управление ролями и разрешениями
- Двухфакторная аутентификация
- Интеграция с внешними системами аутентификации (Telegram)
- Аудит безопасности

## Принципы проектирования

Auth Service следует следующим принципам проектирования:

1. **Чистая архитектура (Clean Architecture)**
   - Независимость от фреймворков
   - Тестируемость
   - Независимость от UI
   - Независимость от баз данных
   - Независимость от внешних агентов

2. **Принципы SOLID**
   - Single Responsibility Principle (SRP)
   - Open/Closed Principle (OCP)
   - Liskov Substitution Principle (LSP)
   - Interface Segregation Principle (ISP)
   - Dependency Inversion Principle (DIP)

3. **Domain-Driven Design (DDD)**
   - Разделение на ограниченные контексты (Bounded Contexts)
   - Использование агрегатов, сущностей и объектов-значений
   - Использование репозиториев для доступа к данным
   - Использование доменных событий для коммуникации

4. **Микросервисная архитектура**
   - Независимое развертывание
   - Децентрализованное управление данными
   - Автоматизированное развертывание
   - Отказоустойчивость
   - Масштабируемость

## Компоненты системы

### API Layer

API Layer отвечает за обработку входящих запросов и преобразование их в вызовы сервисного слоя. Этот слой включает:

1. **HTTP Handlers**
   - Обработка REST API запросов
   - Валидация входящих данных
   - Преобразование DTO в доменные объекты
   - Обработка ошибок и формирование HTTP-ответов

2. **gRPC Servers**
   - Реализация gRPC-сервисов
   - Преобразование protobuf-сообщений в доменные объекты
   - Обработка ошибок и формирование gRPC-ответов

3. **Middleware**
   - Аутентификация и авторизация
   - Логирование
   - Трассировка
   - Ограничение запросов (Rate Limiting)
   - CORS
   - Обработка паники

### Service Layer

Service Layer содержит бизнес-логику приложения и оркестрирует взаимодействие между различными компонентами. Этот слой включает:

1. **Auth Service**
   - Регистрация пользователей
   - Аутентификация пользователей
   - Управление сессиями
   - Верификация email

2. **Token Service**
   - Создание и валидация JWT-токенов
   - Управление refresh-токенами
   - Отзыв токенов

3. **User Service**
   - Управление пользователями
   - Изменение пароля
   - Управление профилем

4. **Role Service**
   - Управление ролями
   - Назначение ролей пользователям
   - Проверка разрешений

5. **Two Factor Service**
   - Включение/отключение 2FA
   - Генерация и проверка TOTP-кодов
   - Управление резервными кодами

6. **Telegram Service**
   - Интеграция с Telegram Login
   - Верификация Telegram-данных

### Domain Layer

Domain Layer содержит бизнес-сущности, правила и интерфейсы репозиториев. Этот слой включает:

1. **Models**
   - User
   - Role
   - Permission
   - Session
   - Token
   - TwoFactorAuth
   - AuditLog

2. **Repository Interfaces**
   - UserRepository
   - RoleRepository
   - SessionRepository
   - TokenRepository
   - AuditLogRepository

3. **Domain Services**
   - PasswordHasher
   - TokenGenerator
   - TOTPGenerator

### Infrastructure Layer

Infrastructure Layer отвечает за взаимодействие с внешними системами и реализацию интерфейсов репозиториев. Этот слой включает:

1. **Repository Implementations**
   - PostgresUserRepository
   - PostgresRoleRepository
   - PostgresSessionRepository
   - RedisTokenRepository
   - PostgresAuditLogRepository

2. **External Services**
   - KafkaProducer
   - KafkaConsumer
   - TelegramClient
   - EmailClient

3. **Database**
   - Migrations
   - Connection Pool
   - Transactions

4. **Cache**
   - Redis Client
   - Cache Strategies

5. **Messaging**
   - Kafka Producer/Consumer
   - Event Serialization/Deserialization

## Потоки данных

### Аутентификация пользователя

1. Пользователь отправляет запрос на `/api/v1/auth/login` с учетными данными
2. HTTP Handler валидирует входящие данные
3. Auth Service проверяет учетные данные через UserRepository
4. При успешной проверке, Token Service генерирует JWT-токены
5. Токены сохраняются в TokenRepository (Redis)
6. Создается запись в AuditLogRepository
7. Токены возвращаются пользователю

### Проверка разрешений

1. Микросервис отправляет gRPC-запрос на `CheckPermission`
2. gRPC Server валидирует входящие данные
3. Token Service проверяет валидность токена
4. Role Service проверяет наличие разрешения у пользователя
5. Результат проверки возвращается микросервису

### Обработка событий

1. Kafka Consumer получает событие из топика
2. Event Handler определяет тип события
3. Соответствующий сервис обрабатывает событие
4. При необходимости, изменения сохраняются в репозиториях
5. При необходимости, генерируются новые события через Kafka Producer

## Интеграции

Auth Service интегрируется со следующими внешними системами:

1. **API Gateway**
   - Проксирование запросов
   - Валидация токенов
   - Маршрутизация

2. **Account Service**
   - Синхронизация данных пользователей
   - Обмен событиями через Kafka

3. **Payment Service**
   - Проверка аутентификации для платежных операций
   - Валидация токенов через gRPC

4. **Developer Service**
   - Управление ролями разработчиков
   - Проверка разрешений через gRPC

5. **Admin Service**
   - Расширенное управление пользователями и ролями
   - Валидация токенов через gRPC

6. **Notification Service**
   - Отправка уведомлений о событиях безопасности
   - Обмен событиями через Kafka

7. **Telegram**
   - Аутентификация через Telegram Login
   - Верификация данных через Telegram API

## Безопасность

Auth Service реализует следующие механизмы безопасности:

1. **Аутентификация**
   - Хеширование паролей с использованием bcrypt
   - JWT-токены с подписью
   - Двухфакторная аутентификация (TOTP)
   - Интеграция с Telegram Login

2. **Авторизация**
   - Ролевая модель контроля доступа (RBAC)
   - Проверка разрешений на уровне API
   - Проверка разрешений на уровне сервисов

3. **Защита данных**
   - Шифрование чувствительных данных
   - Управление секретами через HashiCorp Vault
   - Безопасное хранение токенов в Redis

4. **Защита от атак**
   - Защита от CSRF
   - Защита от XSS
   - Защита от SQL-инъекций
   - Защита от брутфорс-атак
   - Ограничение запросов (Rate Limiting)

5. **Аудит**
   - Логирование всех действий пользователей
   - Логирование всех изменений ролей и разрешений
   - Логирование всех попыток аутентификации

## Масштабирование

Auth Service спроектирован для горизонтального масштабирования:

1. **Stateless Design**
   - Отсутствие состояния в сервисе
   - Хранение состояния в Redis и PostgreSQL

2. **Горизонтальное масштабирование**
   - Возможность запуска нескольких экземпляров сервиса
   - Балансировка нагрузки через Kubernetes/Istio

3. **Кэширование**
   - Кэширование токенов в Redis
   - Кэширование данных пользователей в Redis
   - Кэширование результатов проверки разрешений

4. **Асинхронная обработка**
   - Использование Kafka для асинхронной обработки событий
   - Отложенная обработка неприоритетных операций

## Отказоустойчивость

Auth Service реализует следующие механизмы отказоустойчивости:

1. **Circuit Breaker**
   - Предотвращение каскадных отказов
   - Автоматическое восстановление после сбоев

2. **Retry Mechanism**
   - Повторные попытки при временных сбоях
   - Экспоненциальная задержка между попытками

3. **Fallback Strategies**
   - Альтернативные пути обработки при недоступности зависимостей
   - Деградация функциональности при частичных сбоях

4. **Health Checks**
   - Проверка состояния сервиса
   - Проверка состояния зависимостей
   - Автоматическое восстановление при сбоях

## Мониторинг и логирование

Auth Service предоставляет следующие возможности для мониторинга и логирования:

1. **Метрики**
   - Prometheus-метрики для мониторинга производительности
   - Метрики бизнес-процессов
   - Метрики инфраструктуры

2. **Логирование**
   - Структурированные логи в формате JSON
   - Различные уровни логирования
   - Контекстное логирование

3. **Трассировка**
   - Распределенная трассировка через OpenTelemetry
   - Трассировка запросов через микросервисы
   - Визуализация трассировки в Jaeger

4. **Алертинг**
   - Оповещения о критических ошибках
   - Оповещения о подозрительной активности
   - Оповещения о превышении пороговых значений метрик

## Эволюция архитектуры

Архитектура Auth Service будет эволюционировать в следующих направлениях:

1. **Улучшение безопасности**
   - Внедрение OAuth 2.0 и OpenID Connect
   - Поддержка WebAuthn для аутентификации без паролей
   - Расширенный аудит безопасности

2. **Улучшение производительности**
   - Оптимизация запросов к базе данных
   - Улучшение стратегий кэширования
   - Оптимизация обработки событий

3. **Расширение функциональности**
   - Поддержка дополнительных провайдеров аутентификации
   - Расширенное управление сессиями
   - Улучшенная аналитика безопасности

4. **Улучшение наблюдаемости**
   - Расширенные метрики и логи
   - Улучшенная трассировка
   - Автоматический анализ логов и метрик
